From b8096d480b035c24be28ec747e7812d5f6da66aa Mon Sep 17 00:00:00 2001
From: Raine Makelainen <raine.makelainen@jollamobile.com>
Date: Tue, 7 Apr 2015 11:19:35 +0300
Subject: [PATCH] [xulrunner] Enable external window usage

JB#27561
---
 gfx/gl/GLContextProviderEGL.cpp     |  4 ++++
 gfx/layers/opengl/CompositorOGL.cpp | 11 +++++++++++
 2 files changed, 15 insertions(+)

diff --git a/gfx/gl/GLContextProviderEGL.cpp b/gfx/gl/GLContextProviderEGL.cpp
index e6d89bf..417bd4e 100644
--- a/gfx/gl/GLContextProviderEGL.cpp
+++ b/gfx/gl/GLContextProviderEGL.cpp
@@ -700,6 +700,10 @@ GLContextProviderEGL::CreateWrappingExisting(void* aContext, void* aSurface)
         return nullptr;
     }
 
+    // TODO as soon context and surface guaranteed to be non-null
+    aSurface = aSurface ? aSurface : sEGLLibrary.fGetCurrentSurface(LOCAL_EGL_DRAW);
+    aContext = aContext ? aContext : sEGLLibrary.fGetCurrentContext();
+
     if (aContext && aSurface) {
         SurfaceCaps caps = SurfaceCaps::Any();
         EGLConfig config = EGL_NO_CONFIG;
diff --git a/gfx/layers/opengl/CompositorOGL.cpp b/gfx/layers/opengl/CompositorOGL.cpp
index c64da38..11e6890 100644
--- a/gfx/layers/opengl/CompositorOGL.cpp
+++ b/gfx/layers/opengl/CompositorOGL.cpp
@@ -178,6 +178,17 @@ CompositorOGL::CreateContext()
 {
   nsRefPtr<GLContext> context;
 
+  // If widget has active GL context then we can try to wrap it into Moz GL Context.
+  // Allow widget to create opengl context for the compositor thread and
+  // using surface of an external window.
+  if (PR_GetEnv("MOZ_USE_EXTERNAL_WINDOW") && mWidget->HasGLContext()) {
+    context = GLContextProvider::CreateWrappingExisting(nullptr, nullptr);
+    if (!context || !context->Init()) {
+      NS_WARNING("Failed to create embedded context");
+      context = nullptr;
+    }
+  }
+
   // Allow to create offscreen GL context for main Layer Manager
   if (!context && PR_GetEnv("MOZ_LAYERS_PREFER_OFFSCREEN")) {
     SurfaceCaps caps = SurfaceCaps::ForRGB();
-- 
1.9.1

