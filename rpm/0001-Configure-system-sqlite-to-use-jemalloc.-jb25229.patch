From 2b38e68cc208a26d0e2493a3c138ebea00d5b379 Mon Sep 17 00:00:00 2001
From: Dmitry Rozhkov <dmitry.rozhkov@jolla.com>
Date: Mon, 11 May 2015 12:59:21 +0300
Subject: [PATCH 01/16] Configure system sqlite to use jemalloc. jb25229

---
 embedding/embedlite/EmbedLiteApp.cpp | 65 ++++++++++++++++++++++++++++++++++++
 1 file changed, 65 insertions(+)

diff --git a/embedding/embedlite/EmbedLiteApp.cpp b/embedding/embedlite/EmbedLiteApp.cpp
index 9f9cce0..6763bf8 100644
--- a/embedding/embedlite/EmbedLiteApp.cpp
+++ b/embedding/embedlite/EmbedLiteApp.cpp
@@ -26,6 +26,67 @@

 #include "EmbedLiteCompositorParent.h"

+#include "sqlite3.h"
+#include "mozmemory.h"
+#include "mozilla/mozalloc.h"
+
+// This anonymous namespace is a copy-paste from mozStorageService.cpp
+// used to configure sqlite to use jemalloc.
+namespace {
+
+static void *sqliteMemMalloc(int n)
+{
+  void* p = ::moz_malloc(n);
+  return p;
+}
+
+static void sqliteMemFree(void *p)
+{
+  ::moz_free(p);
+}
+
+static void *sqliteMemRealloc(void *p, int n)
+{
+  return ::moz_realloc(p, n);
+}
+
+static int sqliteMemSize(void *p)
+{
+  return ::moz_malloc_usable_size(p);
+}
+
+static int sqliteMemRoundup(int n)
+{
+  n = malloc_good_size(n);
+
+  // jemalloc can return blocks of size 2 and 4, but SQLite requires that all
+  // allocations be 8-aligned.  So we round up sub-8 requests to 8.  This
+  // wastes a small amount of memory but is obviously safe.
+  return n <= 8 ? 8 : n;
+}
+
+static int sqliteMemInit(void *p)
+{
+  return 0;
+}
+
+static void sqliteMemShutdown(void *p)
+{
+}
+
+const sqlite3_mem_methods memMethods = {
+  &sqliteMemMalloc,
+  &sqliteMemFree,
+  &sqliteMemRealloc,
+  &sqliteMemSize,
+  &sqliteMemRoundup,
+  &sqliteMemInit,
+  &sqliteMemShutdown,
+  nullptr
+};
+
+} // anonymous namespace
+
 namespace mozilla {
 namespace embedlite {

@@ -36,6 +97,10 @@ EmbedLiteApp*
 EmbedLiteApp::GetInstance()
 {
   if (!sSingleton) {
+    // configure sqlite3
+    int rc = ::sqlite3_config(SQLITE_CONFIG_MALLOC, &memMethods);
+    NS_ASSERTION(rc == SQLITE_OK, "Can't configure sqlite!");
+
     sSingleton = new EmbedLiteApp();
     NS_ASSERTION(sSingleton, "not initialized");
   }
--
1.9.1
