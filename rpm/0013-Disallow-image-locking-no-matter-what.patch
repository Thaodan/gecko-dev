From d67c232eaf34bfbe468cc6aa89cc76d1d480b113 Mon Sep 17 00:00:00 2001
From: Dmitry Rozhkov <dmitry.rozhkov@jolla.com>
Date: Mon, 11 May 2015 13:15:40 +0300
Subject: [PATCH 13/16] Disallow image locking no matter what

---
 content/base/src/nsDocument.cpp  | 2 ++
 embedding/embedlite/embedding.js | 2 +-
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/content/base/src/nsDocument.cpp b/content/base/src/nsDocument.cpp
index 3493bce..8bd0003 100644
--- a/content/base/src/nsDocument.cpp
+++ b/content/base/src/nsDocument.cpp
@@ -10040,6 +10040,8 @@ nsDocument::SetImageLockingState(bool aLocked)
       !Preferences::GetBool("image.mem.allow_locking_in_content_processes", true)) {
     return NS_OK;
   }
+  // In embedlite we don't allow locking even if process type is not content.
+  return NS_OK;

   // If there's no change, there's nothing to do.
   if (mLockingImages == aLocked)
diff --git a/embedding/embedlite/embedding.js b/embedding/embedlite/embedding.js
index 67c5f75..571cbb2 100644
--- a/embedding/embedlite/embedding.js
+++ b/embedding/embedlite/embedding.js
@@ -261,7 +261,7 @@ pref("media.preload.auto", 2);    // preload metadata if preload=auto
 // optimize images memory usage
 pref("image.mem.decodeondraw", true);
 pref("image.mem.allow_locking_in_content_processes", false);
-pref("image.mem.min_discard_timeout_ms", 10000);
+pref("image.mem.min_discard_timeout_ms", 86400000); /* 24h, we rely on the out of memory hook */
 pref("image.onload.decode.limit", 24); /* don't decode more than 24 images eagerly */

 // SimplePush
--
1.9.1
