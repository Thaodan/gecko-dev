From bc91a22e31167240bd1f3b85b977c41c37d814ff Mon Sep 17 00:00:00 2001
From: Dmitry Rozhkov <dmitry.rozhkov@jolla.com>
Date: Mon, 11 May 2015 13:16:25 +0300
Subject: [PATCH 14/16] Notify UI about change in composition bounds. jb17999

---
 gfx/layers/apz/src/AsyncPanZoomController.cpp | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/gfx/layers/apz/src/AsyncPanZoomController.cpp b/gfx/layers/apz/src/AsyncPanZoomController.cpp
index f35de78..168ff1f 100644
--- a/gfx/layers/apz/src/AsyncPanZoomController.cpp
+++ b/gfx/layers/apz/src/AsyncPanZoomController.cpp
@@ -1749,6 +1749,7 @@ void AsyncPanZoomController::NotifyLayersUpdated(const FrameMetrics& aLayerMetri

   mPaintThrottler.TaskComplete(GetFrameTime());
   bool needContentRepaint = false;
+  bool needSendScrollEvent = false;
   if (aLayerMetrics.mCompositionBounds.width == mFrameMetrics.mCompositionBounds.width &&
       aLayerMetrics.mCompositionBounds.height == mFrameMetrics.mCompositionBounds.height) {
     // Remote content has sync'd up to the composition geometry
@@ -1766,6 +1767,10 @@ void AsyncPanZoomController::NotifyLayersUpdated(const FrameMetrics& aLayerMetri
     mFrameMetrics.mViewport = aLayerMetrics.mViewport;
   }

+  if (aLayerMetrics.mCompositionBounds.height < mFrameMetrics.mCompositionBounds.height) {
+    needSendScrollEvent = true;
+  }
+
   // If the layers update was not triggered by our own repaint request, then
   // we want to take the new scroll offset. Check the scroll generation as well
   // to filter duplicate calls to NotifyLayersUpdated with the same scroll offset
@@ -1841,6 +1846,8 @@ void AsyncPanZoomController::NotifyLayersUpdated(const FrameMetrics& aLayerMetri

   if (needContentRepaint) {
     RequestContentRepaint();
+  } else if (needSendScrollEvent) {
+    SendAsyncScrollEvent();
   }
   UpdateSharedCompositorFrameMetrics();
 }
@@ -1891,7 +1898,7 @@ void AsyncPanZoomController::ZoomToRect(CSSRect aRect) {
         (currentZoom == localMaxZoom && targetZoom >= localMaxZoom) ||
         (currentZoom == localMinZoom && targetZoom <= localMinZoom)) {
       CSSSize compositedSize = mFrameMetrics.CalculateCompositedSizeInCssPixels();
-      float y = scrollOffset.y;
+      float y = aRect.IsEmpty() ? scrollOffset.y : aRect.y;
       float newHeight =
         cssPageRect.width * (compositedSize.height / compositedSize.width);
       float dh = compositedSize.height - newHeight;
--
1.9.1
